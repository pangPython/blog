# 备份恢复
## 概述
  - 关系数据库的备份恢复的机制原理都一样，差不多
  - 物理备份RMAN（磁盘的数据文件）、归档日志、完全恢复、不完全恢复
  - 恢复的场景
  - 针对任何文件丢失
  - 闪回（用户的误操作），以更小的代价来恢复。
  - 去IOE
  - sqlloder移动数据 逻辑备份
  - 自动化维护，不是优化

## 概念
  - 无故障平均时间 MTBF
  - 故障恢复时间 MTTR
  - 5个9 99.999% 可用性
  - 深入
    - rac集群，保证实例的可用。
    - 容灾：datagold，数据卫士。
    - goodgate，数据传输。
    - 优化：
  - 故障类型：
    - 语句故障-系统自动回滚。
    - 用户进程故障-进程监视器
      - 特殊场景：10个事务，只会恢复没有完成的事务。
    - 网络故障：监听、数据库、客户端。操作系统，防火墙，路由，交换机
    - 误操作
      - 解决方案1：传统方式，不完全恢复，数据库回退，代价太大
      - 解决方案2：flashback，闪回。Oracle特有。代价小。
    - 实例故障
      - 核心故障
      - 硬件故障
      - 下次启动会做清理工作，实例恢复
    - 介质故障
      - 预先做好备份
      - 保留足够的信息
      - 任何已经提交的事务都不会丢失。完全恢复。

## 配置可恢复性
- 不敢保证不出现问题，但是出了问题都能恢复。
- 避免单点故障
- 磁盘上的每一个文件，都可能出问题，都要考虑保护、恢复策略，预案。
- 前期工作很重要，不能丢数据，解决问题时间要短。
- 五种类型的文件：
  - 控制文件、
  - 联机重做日志、
  - 数据文件、
  - 参数文件、
  - 口令文件

## 控制文件
- 出现问题，系统会崩溃
- 创建控制文件多个镜像
- 11g默认两份互为镜像的控制文件，分布在不同的硬件设备上，磁盘，磁盘阵列<数据，备份>
- 检查控制文件路径
  - `select * from v$controlfile;`
  - `show parameter control_files;`
- 修改路径

  ```
  alter system set control_files='','' scope=spfile;
  shutdown immediate;
  mv
  startup
  ```
- 增加镜像，一般3份就可以
```
  - alter system set control_files='','','' scope=spfile;
  - shutdown immediate;
  - cp
  - startup
```
  - 一定要关闭数据库之后再复制，否则报错，控制文件版本不一致，解决办法：使用原先的覆盖版本不一致的

## 日志文件 联机重做日志
- 几组日志切换使用，循环使用，不是互为镜像。第一组写满了再写第二组。
- 查看
  -  `select GROUP#, SEQUENCE#, STATUS, MEMBERS from v$log;`
  -  `select GROUP#, MEMBER from v$logfile;`
- 每次使用日志，会自动生成一个递增的序号sequence
- 是否会有单点故障
  - 日志损坏，本组只有一个日志文件，如果不能写日志，系统就不能工作了。暂时挂起，等待日志是否能使用。解决：组内日志文件做互为镜像。
- 一般两组日志就够
  - 超长的事务
  - 过于频繁的切换，IO变大
  - 经验值：一组日志至少能坚持半个小时，1个小时
  - 经验值：5-8组
- 给某个组添加成员
  - `alter database add logfile member '/home/oracle/redo01.log' to group 1;`
- 添加日志组
  - `alter database add logfile group 2 ('/oracle/log/redo04a.log','/oracle/log2/redo04b.log') size 100M;`

## 联机重做日志与归档日志

## 数据文件 dbf文件
- 查看
```
select name from v$datafile;
```
- 保护数据文件
  - 做镜像。很大，浪费空间。如果有误操作，所有副本中都有误操作，无法恢复。
  - 周期性的做备份。两次备份期间，期间出现问题，还是会丢数据。
  - 两次备份之间，收集备份之间的日志，数据不会丢。
    - 联机重做日志循环使用，可能会覆盖掉，日志不连续，没有价值。
    - 保存写满的日志文件，复制一份保存起来。归档日志。
- 上次全备份+归档日志=最新全量数据
- 归档日志只需要存在在两次全备份之间，不需要保留所有的归档日志。
- FRA快速恢复区
- 开归档模式
